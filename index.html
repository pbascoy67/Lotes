<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa Lotes El Centauro</title>
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-fondo: #B3E5FC; /* Color celeste pastel */
            --color-primario: #4A90E2;
            --color-secundario: #50E3C2;
            --color-texto: #333333;
            --color-boton: #4A90E2;
            --color-boton-hover: #357ABD;
            --color-boton-actualizar: #FF5722;
            --color-boton-actualizar-hover: #E64A19;
            --color-boton-editar: #4CAF50;
            --color-boton-editar-hover: #388E3C;
            --color-lote-propietario: #A5D6A7; /* Verde suave */
            --color-lote-alquilada: #FFF59D; /* Amarillo suave */
            --color-lote-en-proceso: #FFCC80; /* Naranja suave */
            --color-lote-en-venta: #F44336; /* Rojo */
            --color-lote-en-alquiler: #2196F3; /* Azul */
            --color-lote-ambas: #9C27B0; /* Morado */
            --color-leyenda-fondo: #ffffff;
            --color-borde: #dddddd;
            --color-lote-seleccionado: #FFD700; /* Oro para resaltar lote seleccionado */
        }

        /* Estilos CSS */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--color-fondo);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            color: var(--color-texto);
        }

        h1, h3 {
            color: var(--color-texto);
            text-align: center;
        }

        .main-container {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            width: 100%;
        }

        .leyenda, .actualizar-datos {
            padding: 15px;
            background-color: var(--color-leyenda-fondo);
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .leyenda h3, .actualizar-datos h3 {
            margin-top: 0;
            font-weight: 500;
            text-align: center;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .leyenda-color, .leyenda-border {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #000;
            border-radius: 4px;
        }

        .leyenda-color {
            background-color: #fff;
        }

        .border-en-venta {
            border: 2px dashed var(--color-lote-en-venta);
        }

        .border-en-alquiler {
            border: 2px dashed var(--color-lote-en-alquiler);
        }

        .border-ambas {
            border: 2px dashed var(--color-lote-ambas);
        }

        .actualizar-datos button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #ffffff;
        }

        .btn-actualizar {
            background-color: var(--color-boton-actualizar);
        }

        .btn-actualizar:hover {
            background-color: var(--color-boton-actualizar-hover);
        }

        .btn-editar {
            background-color: var(--color-boton-editar);
        }

        .btn-editar:hover {
            background-color: var(--color-boton-editar-hover);
        }

        .button-save {
            margin-top: 10px;
            background-color: var(--color-boton);
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .button-save:hover {
            background-color: var(--color-boton-hover);
        }

        .mapa-container {
            overflow-x: auto;
            white-space: nowrap;
            background-color: var(--color-leyenda-fondo);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1 1 600px;
        }

        .mapa {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
        }

        .calle {
            display: grid;
            grid-template-columns: auto auto auto;
            justify-items: center;
            margin: 0.5cm; /* Reducido de 1cm a 0.5cm */
            position: relative;
        }

        .calle-label {
            /* Cambiado de vertical a horizontal */
            writing-mode: horizontal-tb; /* Cambio a horizontal */
            text-orientation: upright;   /* Orientación de texto horizontal */
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 16px;
            position: absolute;
            top: -30px; /* Ajustado para posición superior */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-leyenda-fondo);
            padding: 2px 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .lado {
            display: flex;
            flex-direction: column;
        }

        .lado-izquierdo {
            justify-content: flex-end;
        }

        .lote {
            width: 70px; /* Reducido de 80px a 70px */
            height: 50px; /* Reducido de 60px a 50px */
            border: 1px solid var(--color-borde);
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px; /* Reducido de 10px a 8px */
            cursor: pointer;
            position: relative;
            border-radius: 4px;
            transition: transform 0.2s, box-shadow 0.2s, border 0.2s;
            user-select: none;
        }

        .lote:hover {
            transform: translateY(-3px); /* Reducido de -5px a -3px */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .lote-seleccionado {
            border: 2px solid var(--color-lote-seleccionado);
        }

        .lote-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            border: none;
            text-align: center;
            width: 60px;
            font-weight: 500;
            /* pointer-events: none; */ /* Removido para hacer editable */
        }

        input[type="text"], 
        input[type="date"], 
        select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            font-family: 'Roboto', Arial, sans-serif;
        }

        .espacio-extra {
            height: 50px; /* Reducido de 70px a 50px */
        }

        /* Estilos para estados y asterisco */
        .estado-propietario {
            background-color: var(--color-lote-propietario);
            color: #ffffff;
        }

        .estado-alquilada {
            background-color: var(--color-lote-alquilada);
            color: #000000;
        }

        .estado-en-proceso {
            background-color: var(--color-lote-en-proceso);
            color: #ffffff;
        }

        .estado-en-venta {
            border: 2px dashed var(--color-lote-en-venta);
        }

        .estado-en-alquiler {
            border: 2px dashed var(--color-lote-en-alquiler);
        }

        .estado-ambas {
            border: 2px dashed var(--color-lote-ambas);
        }

        .asterisco {
            color: red;
            font-weight: bold;
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 14px;
            pointer-events: none;
        }

        /* Estilos para formulario emergente */
        #formularioLote {
            display: none; /* Ocultamos el formulario por defecto */
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffffff;
            padding: 20px;
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            z-index: 1000;
            width: 30%;
            max-width: 90%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #formularioLote h3 {
            margin-top: 0;
            font-weight: 500;
            text-align: center;
        }

        #formularioLote label {
            display: block;
            margin-top: 10px;
            font-weight: 500;
        }

        #formularioLote input, 
        #formularioLote select {
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            padding: 8px;
            font-family: 'Roboto', Arial, sans-serif;
        }

        #formularioLote button {
            margin-top: 15px;
            padding: 8px 12px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Roboto', Arial, sans-serif;
        }

        /* Estilos para los botones dentro del Modal */
        .modal-footer .btn {
            min-width: 100px;
        }

        /* Estilos para el ícono de archivo adjunto */
        .icono-archivo {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 14px;
            color: #555555;
            pointer-events: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .calle {
                margin: 0.3cm; /* Reducido de 0.5cm a 0.3cm */
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }

            .sidebar {
                max-width: 100%;
            }

            .leyenda, .actualizar-datos {
                padding: 10px;
                max-width: 100%;
            }

            .mapa-container {
                padding: 10px;
                flex: 1 1 100%;
            }

            .lote {
                width: 60px; /* Reducido de 70px a 60px */
                height: 45px; /* Reducido de 50px a 45px */
                margin-bottom: 6px; /* Reducido de 8px a 6px */
            }

            #formularioLote {
                width: 90%;
                left: 5%;
                top: 5%;
            }

            .button-save {
                width: 100%;
                padding: 12px 0;
            }

            .calle-label {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .lote {
                width: 50px;
                height: 40px;
            }

            .calle {
                margin: 0.2cm; /* Reducido de 0.3cm a 0.2cm */
            }

            .leyenda-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .leyenda-color, .leyenda-border {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>

<h1>Mapa Lotes El Centauro</h1>

<div class="main-container">
    <!-- Sidebar con Leyenda y Actualizar Datos de Lotes -->
    <div class="sidebar">
        <!-- Sección de leyenda -->
        <div class="leyenda">
            <h3>Descripción de Estados</h3>
            <div class="leyenda-item">
                <div class="leyenda-color estado-propietario"></div>
                <span>Propietario</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-color estado-alquilada"></div>
                <span>Alquilada</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-color estado-en-proceso"></div>
                <span>En Proceso</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-en-venta"></div>
                <span>En venta</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-en-alquiler"></div>
                <span>En alquiler</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-ambas"></div>
                <span>Ambas</span>
            </div>
        </div>

        <!-- Sección Actualizar Datos de Lotes -->
        <div class="actualizar-datos">
            <h3>Actualizar Datos de Lotes</h3>
            <label for="selectCalleEstado">Calle:</label>
            <select id="selectCalleEstado" onchange="actualizarOpcionesLotesEstado()">
                <!-- Opciones de calles generadas dinámicamente -->
            </select>
            <label for="selectLoteEstado">Lote:</label>
            <select id="selectLoteEstado">
                <!-- Opciones de lotes generadas dinámicamente -->
            </select>
            <label for="selectEstado">Estado:</label>
            <select id="selectEstado">
                <!-- Solo tres opciones: Propietario, Alquilada y En Proceso -->
                <option value="propietario">Propietario</option>
                <option value="alquilada">Alquilada</option>
                <option value="en-proceso">En Proceso</option>
            </select>
            <button onclick="actualizarEstadoLote()" class="btn-actualizar">
                <i class="fas fa-sync-alt"></i> Actualizar Lote
            </button>
            <button onclick="mostrarFormularioDesdeEstado()" class="btn-editar">
                <i class="fas fa-edit"></i> Editar Lote
            </button>
            <!-- Botón Guardar Configuración movido aquí -->
            <button class="button-save btn btn-primary" onclick="guardarConfiguracion()">
                <i class="fas fa-save me-2"></i>Guardar Configuración
            </button>
        </div>
    </div>

    <!-- Contenedor del mapa -->
    <div class="mapa-container">
        <div class="mapa">
            <!-- Calles 1 a 7 -->
            <!-- Calle 1 -->
            <div class="calle">
                <div class="lado lado-izquierdo" id="ladoIzquierdo1">
                    <div class="lote">1</div>
                    <div class="lote">2</div>
                    <div class="lote">3</div>
                </div>
                <div class="calle-label">Calle 1</div>
                <div class="lado" id="ladoDerecho1">
                    <div class="lote">4</div>
                    <div class="lote">5</div>
                </div>
            </div>
            <!-- Calle 2 -->
            <div class="calle">
                <div class="lado lado-izquierdo" id="ladoIzquierdo2">
                    <div class="lote">6</div>
                    <div class="lote">7</div>
                </div>
                <div class="calle-label">Calle 2</div>
                <div class="lado" id="ladoDerecho2">
                    <div class="lote">8</div>
                    <div class="lote">9</div>
                </div>
            </div>
            <!-- Calle 3 -->
            <div class="calle">
                <div class="lado lado-izquierdo" id="ladoIzquierdo3">
                    <div class="lote">10</div>
                    <div class="lote">11</div>
                </div>
                <div class="calle-label">Calle 3</div>
                <div class="lado" id="ladoDerecho3">
                    <div class="lote">12</div>
                    <div class="lote">13</div>
                </div>
            </div>
            <!-- Calle 4 -->
            <div class="calle">
                <div class="lado lado-izquierdo" id="ladoIzquierdo4">
                    <div class="lote">14</div>
                    <div class="lote">15</div>
                </div>
                <div class="calle-label">Calle 4</div>
                <div class="lado" id="ladoDerecho4">
                    <div class="lote">16</div>
                    <div class="lote">17</div>
                </div>
            </div>
            <!-- Calle 5 -->
            <div class="calle">
                <div class="lado lado-izquierdo" id="ladoIzquierdo5">
                    <div class="lote">18</div>
                    <div class="lote">19</div>
                </div>
                <div class="calle-label">Calle 5</div>
                <div class="lado" id="ladoDerecho5">
                    <div class="lote">20</div>
                    <div class="lote">21</div>
                </div>
            </div>
            <!-- Calle 6 -->
            <div class="calle">
                <div class="lado lado-izquierdo" id="ladoIzquierdo6">
                    <div class="lote">22</div>
                    <div class="lote">23</div>
                </div>
                <div class="calle-label">Calle 6</div>
                <div class="lado" id="ladoDerecho6">
                    <div class="lote">24</div>
                    <div class="lote">25</div>
                </div>
            </div>
            <!-- Calle 7 -->
            <div class="calle">
                <!-- Lote 1 en la parte superior izquierda -->
                <div class="lado lado-izquierdo" id="ladoIzquierdo7">
                    <div class="lote">1</div>
                    <div class="lote">13</div>
                    <div class="lote">12</div>
                    <div class="lote">11</div>
                    <div class="lote">10</div>
                    <div class="lote">9</div>
                    <div class="lote">8</div>
                </div>
                <div class="calle-label">Calle 7</div>
                <!-- Lotes 2 al 7 en el lado derecho -->
                <div class="lado" id="ladoDerecho7">
                    <div class="lote">2</div>
                    <div class="lote">3</div>
                    <div class="lote">4</div>
                    <div class="lote">5</div>
                    <div class="lote">6</div>
                    <div class="lote">7</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Formulario emergente para editar datos del lote -->
<div id="formularioLote">
    <h3>Datos del Lote</h3>
    <label for="propietario">Nombre y Apellido del Propietario:</label>
    <input type="text" id="propietario" required>

    <label for="inquilino">Nombre y Apellido del Inquilino:</label>
    <input type="text" id="inquilino">

    <label for="fechaDesde">Fecha Contrato Desde:</label>
    <input type="date" id="fechaDesde">

    <label for="fechaHasta">Fecha Contrato Hasta:</label>
    <input type="date" id="fechaHasta">

    <label for="enProceso">En Proceso de:</label>
    <select id="enProceso">
        <option value="">Seleccione</option>
        <option value="en-venta">En Venta</option>
        <option value="en-alquiler">En Alquiler</option>
        <option value="ambas">Ambas</option>
    </select>

    <!-- Campo para cargar archivos -->
    <label for="archivo">Adjuntar archivo:</label>
    <input type="file" id="archivo" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg">

    <!-- Previsualización de la imagen adjunta -->
    <img id="previsualizacionArchivo" src="#" alt="Previsualización" style="display: none; max-width: 100%; margin-top: 10px;">

    <!-- Enlace para ver o descargar el archivo adjunto -->
    <div id="archivoAdjunto" style="margin-top: 10px; display: none;">
        <a href="#" id="enlaceArchivo" target="_blank" download>
            <i class="fas fa-paperclip me-2"></i>Ver archivo adjunto
        </a>
        <button type="button" class="btn btn-danger btn-sm" onclick="borrarArchivoAdjunto()" id="botonBorrarArchivo" style="display: none;">
            <i class="fas fa-trash-alt me-2"></i>Borrar Archivo
        </button>
    </div>

    <button onclick="guardarDatosLote()" class="btn btn-primary">
        <i class="fas fa-save me-2"></i>Guardar
    </button>
    <button onclick="cerrarFormulario()" class="btn btn-secondary">
        <i class="fas fa-times me-2"></i>Cancelar
    </button>
</div>

<script>
    // Definición de lotes para cada calle
    let lotesCalle1 = [
        { id: '1', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '2', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '3', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '4', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '5', lado: 'derecho', estado: '', datos: {}, elemento: null },
    ];
    let lotesCalle2 = [
        { id: '6', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '7', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '8', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '9', lado: 'derecho', estado: '', datos: {}, elemento: null },
    ];
    let lotesCalle3 = [
        { id: '10', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '11', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '12', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '13', lado: 'derecho', estado: '', datos: {}, elemento: null },
    ];
    let lotesCalle4 = [
        { id: '14', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '15', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '16', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '17', lado: 'derecho', estado: '', datos: {}, elemento: null },
    ];
    let lotesCalle5 = [
        { id: '18', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '19', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '20', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '21', lado: 'derecho', estado: '', datos: {}, elemento: null },
    ];
    let lotesCalle6 = [
        { id: '22', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '23', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '24', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '25', lado: 'derecho', estado: '', datos: {}, elemento: null },
    ];
    let lotesCalle7 = [
        { id: '1', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '2', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '3', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '4', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '5', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '6', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '7', lado: 'derecho', estado: '', datos: {}, elemento: null },
        { id: '8', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '9', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '10', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '11', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '12', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
        { id: '13', lado: 'izquierdo', estado: '', datos: {}, elemento: null },
    ];

    // Variable global para el lote actual
    let loteActual;

    window.onload = function() {
        // Cargar lotes desde localStorage
        if (localStorage.getItem('lotesCalle1')) {
            lotesCalle1 = JSON.parse(localStorage.getItem('lotesCalle1'));
        }
        if (localStorage.getItem('lotesCalle2')) {
            lotesCalle2 = JSON.parse(localStorage.getItem('lotesCalle2'));
        }
        if (localStorage.getItem('lotesCalle3')) {
            lotesCalle3 = JSON.parse(localStorage.getItem('lotesCalle3'));
        }
        if (localStorage.getItem('lotesCalle4')) {
            lotesCalle4 = JSON.parse(localStorage.getItem('lotesCalle4'));
        }
        if (localStorage.getItem('lotesCalle5')) {
            lotesCalle5 = JSON.parse(localStorage.getItem('lotesCalle5'));
        }
        if (localStorage.getItem('lotesCalle6')) {
            lotesCalle6 = JSON.parse(localStorage.getItem('lotesCalle6'));
        }
        if (localStorage.getItem('lotesCalle7')) {
            lotesCalle7 = JSON.parse(localStorage.getItem('lotesCalle7'));
        }

        generarLotes();
        generarOpcionesCallesEstado(); // Genera las opciones de calles
        actualizarOpcionesLotesEstado(); // Genera las opciones de lotes según la calle seleccionada

        // Restaurar estados y eventos
        restaurarEstados(lotesCalle1);
        restaurarEstados(lotesCalle2);
        restaurarEstados(lotesCalle3);
        restaurarEstados(lotesCalle4);
        restaurarEstados(lotesCalle5);
        restaurarEstados(lotesCalle6);
        restaurarEstados(lotesCalle7);
    };

    function generarLotes() {
        // Generar lotes para cada calle
        generarLotesPorCalle('1', lotesCalle1);
        generarLotesPorCalle('2', lotesCalle2);
        generarLotesPorCalle('3', lotesCalle3);
        generarLotesPorCalle('4', lotesCalle4);
        generarLotesPorCalle('5', lotesCalle5);
        generarLotesPorCalle('6', lotesCalle6);
        generarLotesPorCalle('7', lotesCalle7);
    }

    function generarLotesPorCalle(numeroCalle, lotesCalle, agregarEspacioExtra = true) {
        const ladoIzquierdo = document.getElementById(`ladoIzquierdo${numeroCalle}`);
        const ladoDerecho = document.getElementById(`ladoDerecho${numeroCalle}`);

        ladoIzquierdo.innerHTML = '';
        ladoDerecho.innerHTML = agregarEspacioExtra ? '<div class="espacio-extra"></div>' : '';

        lotesCalle.forEach((lote, index) => {
            const inputLote = document.createElement('input');
            inputLote.type = 'text';
            inputLote.value = lote.id || '';
            inputLote.placeholder = 'Lote';
            inputLote.className = 'lote-input';
            inputLote.onchange = (e) => {
                lote.id = e.target.value;
                generarOpcionesCallesEstado();
                actualizarOpcionesLotesEstado();
            };

            const divLote = document.createElement('div');
            divLote.classList.add('lote');

            // Aplicar clase de estado si existe
            if (lote.estado) {
                divLote.classList.add(`estado-${lote.estado}`);
            }

            // Si tiene datos de "En Proceso de", aplicamos la clase correspondiente
            if (lote.datos && lote.datos.enProceso) {
                divLote.classList.add(`estado-${lote.datos.enProceso}`);
            }

            // Añadir asteriscos
            // Primero, eliminar cualquier asterisco existente para evitar duplicados
            const existingAsteriscos = divLote.querySelectorAll('.asterisco');
            existingAsteriscos.forEach(a => divLote.removeChild(a));

            if (lote.datos && (lote.datos.propietario || lote.datos.inquilino || lote.datos.fechaDesde || lote.datos.fechaHasta || lote.datos.enProceso || lote.datos.archivo)) {
                // Añadir un asterisco para indicar que hay datos
                const asterisco1 = document.createElement('span');
                asterisco1.textContent = '*';
                asterisco1.className = 'asterisco';
                divLote.appendChild(asterisco1);

                // Añadir un segundo asterisco si hay un archivo adjunto
                if (lote.datos.archivo && lote.datos.archivoNombre) {
                    const asterisco2 = document.createElement('span');
                    asterisco2.textContent = '*';
                    asterisco2.className = 'asterisco';
                    asterisco2.style.right = '18px'; // Ajustar posición para el segundo asterisco
                    divLote.appendChild(asterisco2);
                }
            }

            // Añadir ícono de archivo adjunto si existe (con Font Awesome)
            if (lote.datos && lote.datos.archivo && lote.datos.archivoNombre) {
                const iconoArchivo = document.createElement('i');
                iconoArchivo.className = 'fas fa-paperclip icono-archivo';
                divLote.appendChild(iconoArchivo);
            }

            divLote.appendChild(inputLote);

            // Agregar evento click para abrir el formulario de edición
            divLote.onclick = (e) => {
                // Evitar que el click en el input active el evento
                if (e.target.tagName.toLowerCase() === 'input') return;

                loteActual = lote;
                abrirFormulario();
            };

            if (lote.lado === 'izquierdo') {
                ladoIzquierdo.appendChild(divLote);
            } else {
                ladoDerecho.appendChild(divLote);
            }

            // Guardar referencia al elemento divLote
            lote.elemento = divLote;
        });
    }

    function generarOpcionesCallesEstado() {
        const selectCalleEstado = document.getElementById('selectCalleEstado');
        selectCalleEstado.innerHTML = '';

        for (let i = 1; i <= 7; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Calle ${i}`;
            selectCalleEstado.appendChild(option);
        }
    }

    function actualizarOpcionesLotesEstado() {
        const selectCalleEstado = document.getElementById('selectCalleEstado');
        const selectLoteEstado = document.getElementById('selectLoteEstado');
        const numeroCalle = selectCalleEstado.value;
        selectLoteEstado.innerHTML = '';

        let lotesCalle = obtenerLotesCalle(numeroCalle);
        if (!lotesCalle) {
            alert('Calle no válida.');
            return;
        }

        // Eliminar la ordenación para mantener el orden original de los lotes
        // lotesCalle.sort((a, b) => parseInt(a.id) - parseInt(b.id));

        lotesCalle.forEach(lote => {
            if (lote.id) {
                const option = document.createElement('option');
                option.value = lote.id;
                option.textContent = `Lote ${lote.id}`;
                selectLoteEstado.appendChild(option);
            }
        });
    }

    function obtenerLotesCalle(numeroCalle) {
        const lotes = {
            '1': lotesCalle1,
            '2': lotesCalle2,
            '3': lotesCalle3,
            '4': lotesCalle4,
            '5': lotesCalle5,
            '6': lotesCalle6,
            '7': lotesCalle7
        };
        return lotes[numeroCalle] || null;
    }

    function actualizarEstadoLote() {
        const selectCalleEstado = document.getElementById('selectCalleEstado');
        const selectLoteEstado = document.getElementById('selectLoteEstado');
        const selectEstado = document.getElementById('selectEstado');
        const numeroCalle = selectCalleEstado.value;
        const idLote = selectLoteEstado.value;
        const estado = selectEstado.value;

        if (!idLote) {
            alert('Por favor, selecciona un lote válido.');
            return;
        }

        let lotesCalle = obtenerLotesCalle(numeroCalle);
        if (!lotesCalle) {
            alert('Calle no válida.');
            return;
        }

        const lote = lotesCalle.find(l => l.id == idLote);

        if (!lote) {
            alert('Lote no encontrado.');
            return;
        }

        // Actualizar el estado del lote
        lote.estado = estado;

        // Remover clases de estado anteriores
        lote.elemento.classList.remove('estado-propietario', 'estado-alquilada', 'estado-en-proceso', 'estado-en-venta', 'estado-en-alquiler', 'estado-ambas');

        // Añadir la clase de estado correspondiente
        lote.elemento.classList.add(`estado-${estado}`);

        // Actualizar asteriscos
        actualizarAsteriscos(lote);

        alert(`Estado del Lote ${idLote} en Calle ${numeroCalle} actualizado a ${estado}.`);
    }

    function mostrarFormularioDesdeEstado() {
        const selectCalleEstado = document.getElementById('selectCalleEstado');
        const selectLoteEstado = document.getElementById('selectLoteEstado');
        const numeroCalle = selectCalleEstado.value;
        const idLote = selectLoteEstado.value;

        if (!idLote) {
            alert('Por favor, selecciona un lote válido.');
            return;
        }

        let lotesCalle = obtenerLotesCalle(numeroCalle);
        if (!lotesCalle) {
            alert('Calle no válida.');
            return;
        }

        loteActual = lotesCalle.find(l => l.id == idLote);

        if (!loteActual) {
            alert('Lote no encontrado.');
            return;
        }

        // Asegurarse de que loteActual.datos existe
        if (!loteActual.datos) {
            loteActual.datos = {};
        }

        // Cargar los datos del lote en el formulario
        document.getElementById('propietario').value = loteActual.datos.propietario || '';
        document.getElementById('inquilino').value = loteActual.datos.inquilino || '';
        document.getElementById('fechaDesde').value = loteActual.datos.fechaDesde || '';
        document.getElementById('fechaHasta').value = loteActual.datos.fechaHasta || '';
        document.getElementById('enProceso').value = loteActual.datos.enProceso || '';

        // Mostrar enlace para ver el archivo adjunto si existe
        const archivoAdjuntoDiv = document.getElementById('archivoAdjunto');
        const enlaceArchivo = document.getElementById('enlaceArchivo');
        const botonBorrarArchivo = document.getElementById('botonBorrarArchivo');

        if (loteActual.datos.archivo && loteActual.datos.archivoNombre) {
            archivoAdjuntoDiv.style.display = 'block';
            enlaceArchivo.href = loteActual.datos.archivo;
            enlaceArchivo.innerHTML = `<i class="fas fa-paperclip me-2"></i>Ver archivo adjunto (${loteActual.datos.archivoNombre})`;
            enlaceArchivo.download = loteActual.datos.archivoNombre; // Añadido atributo download
            botonBorrarArchivo.style.display = 'inline-block'; // Mostrar botón de borrar archivo
        } else {
            archivoAdjuntoDiv.style.display = 'none';
            enlaceArchivo.href = '#';
            enlaceArchivo.innerHTML = '<i class="fas fa-paperclip me-2"></i>';
            enlaceArchivo.removeAttribute('download'); // Remover atributo download si no hay archivo
            botonBorrarArchivo.style.display = 'none'; // Ocultar botón de borrar archivo
        }

        // Limpiar el campo de archivo
        document.getElementById('archivo').value = '';
        delete document.getElementById('archivo').dataset.previousFileName;

        // Mostrar el formulario
        abrirFormulario();
    }

    function abrirFormulario() {
        if (!loteActual) return;

        // Asegurarse de que loteActual.datos existe
        if (!loteActual.datos) {
            loteActual.datos = {};
        }

        // Cargar los datos del lote en el formulario
        document.getElementById('propietario').value = loteActual.datos.propietario || '';
        document.getElementById('inquilino').value = loteActual.datos.inquilino || '';
        document.getElementById('fechaDesde').value = loteActual.datos.fechaDesde || '';
        document.getElementById('fechaHasta').value = loteActual.datos.fechaHasta || '';
        document.getElementById('enProceso').value = loteActual.datos.enProceso || '';

        // Mostrar enlace para ver el archivo adjunto si existe
        const archivoAdjuntoDiv = document.getElementById('archivoAdjunto');
        const enlaceArchivo = document.getElementById('enlaceArchivo');
        const botonBorrarArchivo = document.getElementById('botonBorrarArchivo');

        if (loteActual.datos.archivo && loteActual.datos.archivoNombre) {
            archivoAdjuntoDiv.style.display = 'block';
            enlaceArchivo.href = loteActual.datos.archivo;
            enlaceArchivo.innerHTML = `<i class="fas fa-paperclip me-2"></i>Ver archivo adjunto (${loteActual.datos.archivoNombre})`;
            enlaceArchivo.download = loteActual.datos.archivoNombre; // Añadido atributo download
            botonBorrarArchivo.style.display = 'inline-block'; // Mostrar botón de borrar archivo
        } else {
            archivoAdjuntoDiv.style.display = 'none';
            enlaceArchivo.href = '#';
            enlaceArchivo.innerHTML = '<i class="fas fa-paperclip me-2"></i>';
            enlaceArchivo.removeAttribute('download'); // Remover atributo download si no hay archivo
            botonBorrarArchivo.style.display = 'none'; // Ocultar botón de borrar archivo
        }

        // Limpiar el campo de archivo
        document.getElementById('archivo').value = '';
        delete document.getElementById('archivo').dataset.previousFileName;

        // Mostrar el formulario
        document.getElementById('formularioLote').style.display = 'block';

        // Resaltar el lote seleccionado
        resaltarLoteSeleccionado(loteActual);
    }

    function guardarDatosLote() {
        if (!loteActual) {
            alert('No hay un lote seleccionado.');
            return;
        }

        // Validar campos obligatorios
        const propietario = document.getElementById('propietario').value.trim();
        if (propietario === '') {
            alert('El campo "Propietario" es obligatorio.');
            return;
        }

        // Asegurarse de que loteActual.datos existe
        if (!loteActual.datos) {
            loteActual.datos = {};
        }

        const inquilino = document.getElementById('inquilino').value;
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        const enProceso = document.getElementById('enProceso').value;

        // Manejo del archivo adjunto
        const archivoInput = document.getElementById('archivo');
        const archivo = archivoInput.files[0];

        if (archivo) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const contenidoArchivo = e.target.result;
                loteActual.datos.archivo = contenidoArchivo; // Contenido del archivo en base64
                loteActual.datos.archivoNombre = archivo.name;

                // Guardar los demás datos después de leer el archivo
                guardarDatosLoteContinua(propietario, inquilino, fechaDesde, fechaHasta, enProceso);
            };
            reader.onerror = function() {
                alert('Error al leer el archivo.');
            };
            reader.readAsDataURL(archivo);
        } else {
            // No se seleccionó un nuevo archivo
            // Si ya existía un archivo adjunto, lo conservamos
            // Si no, eliminamos los datos del archivo
            if (!loteActual.datos.archivo || !loteActual.datos.archivoNombre) {
                delete loteActual.datos.archivo;
                delete loteActual.datos.archivoNombre;
            }
            guardarDatosLoteContinua(propietario, inquilino, fechaDesde, fechaHasta, enProceso);
        }
    }

    function guardarDatosLoteContinua(propietario, inquilino, fechaDesde, fechaHasta, enProceso) {
        // Guardar los demás datos
        loteActual.datos.propietario = propietario;
        loteActual.datos.inquilino = inquilino;
        loteActual.datos.fechaDesde = fechaDesde;
        loteActual.datos.fechaHasta = fechaHasta;
        loteActual.datos.enProceso = enProceso;

        // Removemos clases anteriores de "En Proceso de"
        loteActual.elemento.classList.remove('estado-en-venta', 'estado-en-alquiler', 'estado-ambas');

        // Si tiene un estado de "En Proceso de", añadimos la clase correspondiente
        if (enProceso) {
            loteActual.elemento.classList.add(`estado-${enProceso}`);
        }

        // Actualizar asteriscos
        actualizarAsteriscos(loteActual);

        // Añadir o remover ícono de archivo adjunto
        const existingIconoArchivo = loteActual.elemento.querySelector('.icono-archivo');
        if (loteActual.datos.archivo && loteActual.datos.archivoNombre) {
            if (!existingIconoArchivo) {
                const iconoArchivo = document.createElement('i');
                iconoArchivo.className = 'fas fa-paperclip icono-archivo';
                loteActual.elemento.appendChild(iconoArchivo);
            }
        } else {
            if (existingIconoArchivo) {
                loteActual.elemento.removeChild(existingIconoArchivo);
            }
        }

        cerrarFormulario();
        loteActual = null;
    }

    function actualizarAsteriscos(lote) {
        const existingAsteriscos = lote.elemento.querySelectorAll('.asterisco');
        existingAsteriscos.forEach(a => lote.elemento.removeChild(a));

        if (lote.datos && (lote.datos.propietario || lote.datos.inquilino || lote.datos.fechaDesde || lote.datos.fechaHasta || lote.datos.enProceso || lote.datos.archivo)) {
            // Añadir un asterisco para indicar que hay datos
            const asterisco1 = document.createElement('span');
            asterisco1.textContent = '*';
            asterisco1.className = 'asterisco';
            lote.elemento.appendChild(asterisco1);

            // Añadir un segundo asterisco si hay un archivo adjunto
            if (lote.datos.archivo && lote.datos.archivoNombre) {
                const asterisco2 = document.createElement('span');
                asterisco2.textContent = '*';
                asterisco2.className = 'asterisco';
                asterisco2.style.right = '18px'; // Ajustar posición para el segundo asterisco
                lote.elemento.appendChild(asterisco2);
            }
        }
    }

    function borrarArchivoAdjunto() {
        if (!loteActual) {
            alert('No hay un lote seleccionado.');
            return;
        }

        // Confirmar la acción de borrado
        const confirmBorrar = confirm('¿Estás seguro de que deseas borrar el archivo adjunto?');
        if (!confirmBorrar) {
            return;
        }

        // Eliminar los datos del archivo adjunto
        delete loteActual.datos.archivo;
        delete loteActual.datos.archivoNombre;

        // Remover el enlace de archivo adjunto en el formulario
        const archivoAdjuntoDiv = document.getElementById('archivoAdjunto');
        const enlaceArchivo = document.getElementById('enlaceArchivo');
        enlaceArchivo.href = '#';
        enlaceArchivo.innerHTML = '<i class="fas fa-paperclip me-2"></i>';
        enlaceArchivo.removeAttribute('download'); // Remover atributo download
        archivoAdjuntoDiv.style.display = 'none';

        // Remover el ícono de archivo adjunto en el mapa
        const existingIconoArchivo = loteActual.elemento.querySelector('.icono-archivo');
        if (existingIconoArchivo) {
            loteActual.elemento.removeChild(existingIconoArchivo);
        }

        // Ocultar el botón de borrar archivo
        const botonBorrarArchivo = document.getElementById('botonBorrarArchivo');
        botonBorrarArchivo.style.display = 'none';

        // Actualizar asteriscos
        actualizarAsteriscos(loteActual);

        alert('Archivo adjunto borrado correctamente.');
    }

    function cerrarFormulario() {
        document.getElementById('formularioLote').style.display = 'none';
        // Limpiar formulario
        document.getElementById('propietario').value = '';
        document.getElementById('inquilino').value = '';
        document.getElementById('fechaDesde').value = '';
        document.getElementById('fechaHasta').value = '';
        document.getElementById('enProceso').value = '';
        document.getElementById('archivo').value = '';
        delete document.getElementById('archivo').dataset.previousFileName;
        document.getElementById('archivoAdjunto').style.display = 'none';
        document.getElementById('enlaceArchivo').innerHTML = '<i class="fas fa-paperclip me-2"></i>';
        document.getElementById('enlaceArchivo').href = '#';
        document.getElementById('enlaceArchivo').removeAttribute('download');
        document.getElementById('botonBorrarArchivo').style.display = 'none';

        // Remover resalte del lote
        removerResaltadoLote();
    }

    function guardarConfiguracion() {
        try {
            // Guardar en localStorage
            localStorage.setItem('lotesCalle1', JSON.stringify(lotesCalle1));
            localStorage.setItem('lotesCalle2', JSON.stringify(lotesCalle2));
            localStorage.setItem('lotesCalle3', JSON.stringify(lotesCalle3));
            localStorage.setItem('lotesCalle4', JSON.stringify(lotesCalle4));
            localStorage.setItem('lotesCalle5', JSON.stringify(lotesCalle5));
            localStorage.setItem('lotesCalle6', JSON.stringify(lotesCalle6));
            localStorage.setItem('lotesCalle7', JSON.stringify(lotesCalle7));

            alert("Configuración guardada exitosamente.");
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                alert('No se pudo guardar la configuración. Se ha excedido el límite de almacenamiento en el navegador.');
            } else {
                alert('Error al guardar la configuración: ' + e.message);
            }
        }
    }

    function restaurarEstados(lotesCalle) {
        lotesCalle.forEach(lote => {
            if (lote.elemento) {
                // Removemos clases anteriores
                lote.elemento.classList.remove('estado-propietario', 'estado-alquilada', 'estado-en-proceso', 'estado-en-venta', 'estado-en-alquiler', 'estado-ambas');

                // Añadimos la clase de estado si existe
                if (lote.estado) {
                    lote.elemento.classList.add(`estado-${lote.estado}`);
                }

                // Si tiene datos de "En Proceso de", añadimos la clase correspondiente
                if (lote.datos && lote.datos.enProceso) {
                    lote.elemento.classList.add(`estado-${lote.datos.enProceso}`);
                }

                // Añadir asteriscos
                // Primero, eliminar cualquier asterisco existente para evitar duplicados
                const existingAsteriscos = lote.elemento.querySelectorAll('.asterisco');
                existingAsteriscos.forEach(a => lote.elemento.removeChild(a));

                if (lote.datos && (lote.datos.propietario || lote.datos.inquilino || lote.datos.fechaDesde || lote.datos.fechaHasta || lote.datos.enProceso || lote.datos.archivo)) {
                    // Añadir un asterisco para indicar que hay datos
                    const asterisco1 = document.createElement('span');
                    asterisco1.textContent = '*';
                    asterisco1.className = 'asterisco';
                    lote.elemento.appendChild(asterisco1);

                    // Añadir un segundo asterisco si hay un archivo adjunto
                    if (lote.datos.archivo && lote.datos.archivoNombre) {
                        const asterisco2 = document.createElement('span');
                        asterisco2.textContent = '*';
                        asterisco2.className = 'asterisco';
                        asterisco2.style.right = '18px'; // Ajustar posición para el segundo asterisco
                        lote.elemento.appendChild(asterisco2);
                    }
                }

                // Añadir ícono de archivo adjunto si existe (con Font Awesome)
                const existingIconoArchivo = lote.elemento.querySelector('.icono-archivo');
                if (lote.datos && lote.datos.archivo && lote.datos.archivoNombre) {
                    if (!existingIconoArchivo) {
                        const iconoArchivo = document.createElement('i');
                        iconoArchivo.className = 'fas fa-paperclip icono-archivo';
                        lote.elemento.appendChild(iconoArchivo);
                    }
                } else {
                    if (existingIconoArchivo) {
                        lote.elemento.removeChild(existingIconoArchivo);
                    }
                }

                // Actualizar tooltip
                actualizarTooltips(lote);
            }
        });
    }

    function actualizarTooltips(lote) {
        const tooltipText = `
            Propietario: ${lote.datos.propietario || 'N/A'}
            Inquilino: ${lote.datos.inquilino || 'N/A'}
            Estado: ${lote.estado || 'N/A'}
        `;
        lote.elemento.setAttribute('title', tooltipText);
    }

    // Función para resaltar el lote seleccionado
    function resaltarLoteSeleccionado(lote) {
        // Remover resaltado previo
        removerResaltadoLote();

        // Añadir clase de resaltado al lote actual
        lote.elemento.classList.add('lote-seleccionado');
    }

    // Función para remover el resaltado del lote seleccionado
    function removerResaltadoLote() {
        const lotes = document.querySelectorAll('.lote-seleccionado');
        lotes.forEach(lote => {
            lote.classList.remove('lote-seleccionado');
        });
    }

</script>

</body>
</html>
